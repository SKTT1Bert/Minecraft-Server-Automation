#!/bin/bash

# Minecraft Server Stop Script
# Generated by Ansible

MINECRAFT_DIR="{{ minecraft_dir }}"
PID_FILE="$MINECRAFT_DIR/minecraft.pid"

# Function to gracefully stop the server
stop_server() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        
        if kill -0 "$PID" 2>/dev/null; then
            echo "Stopping Minecraft server (PID: $PID)..."
            
            # Try to send save-all command (if possible)
            # Note: This would require a more complex setup with screen or tmux
            
            # Send SIGTERM for graceful shutdown
            kill -TERM "$PID"
            
            # Wait for the process to stop gracefully
            local count=0
            while kill -0 "$PID" 2>/dev/null && [ $count -lt 30 ]; do
                echo "Waiting for server to stop... ($count/30)"
                sleep 2
                count=$((count + 1))
            done
            
            # If still running, force kill
            if kill -0 "$PID" 2>/dev/null; then
                echo "Server didn't stop gracefully, forcing shutdown..."
                kill -KILL "$PID"
                sleep 2
            fi
            
            # Remove PID file
            rm -f "$PID_FILE"
            
            echo "Minecraft server stopped successfully"
        else
            echo "Process $PID not running, removing stale PID file"
            rm -f "$PID_FILE"
        fi
    else
        echo "No PID file found, server might not be running"
    fi
}

# Check if server is running
if [ ! -f "$PID_FILE" ]; then
    echo "Minecraft server is not running (no PID file)"
    exit 0
fi

# Stop the server
stop_server

# Final check
if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
    echo "Failed to stop Minecraft server"
    exit 1
else
    echo "Minecraft server stopped"
    exit 0
fi 